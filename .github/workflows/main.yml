name: Daily Wantgoo Monitor

on:
  schedule:
    # GitHub ä½¿ç”¨ UTC æ™‚é–“ï¼Œå°ç£æ™‚é–“æ—©ä¸Š 8 é» = UTC 0 é»
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•æ¸¬è©¦æŒ‰éˆ•

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install libraries
        run: |
          pip install requests beautifulsoup4

      - name: Run Scraper and Send LINE
        env:
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          from datetime import datetime

          # 1. æŠ“å–è³‡æ–™
          url = 'https://www.wantgoo.com/futures/retail-indicator/wtm'
          headers = {'User-Agent': 'Mozilla/5.0'}
          
          try:
              response = requests.get(url, headers=headers)
              soup = BeautifulSoup(response.text, 'html.parser')
              
              # å°‹æ‰¾è¡¨æ ¼æ•¸æ“š (é‡å°è©²ç¶²é çµæ§‹)
              # ç©è‚¡ç¶²çš„è¡¨æ ¼é€šå¸¸åœ¨ tbody å…§ï¼Œç¬¬ä¸€è¡Œæ˜¯æœ€æ–°çš„
              rows = soup.select('tbody tr')
              if not rows:
                  print('æ‰¾ä¸åˆ°æ•¸æ“š')
                  exit()
                  
              latest_row = rows[0]
              cols = latest_row.find_all('td')
              
              # æ¬„ä½ï¼šæ—¥æœŸ(0), æ”¶ç›¤åƒ¹(1), å¤šå–®(2), ç©ºå–®(3), å¤šç©ºæ¯”(4)
              date_str = cols[0].text.strip()
              ratio_str = cols[4].text.strip().replace('%', '')
              ratio = float(ratio_str)
              
              # 2. é€²è¡Œå¤šç©ºåˆ¤æ–·
              suggestion = ''
              if ratio > 20:
                  suggestion = 'ğŸ”´ åç©ºè­¦ç¤ºï¼(æ•£æˆ¶å¤§èˆ‰åšå¤šï¼Œä¸»åŠ›å¯èƒ½æ®ºå¤š)'
              elif ratio > 0:
                  suggestion = 'â˜ï¸ éœ‡ç›ªåç©º (æ•£æˆ¶ç•¥å¾®çœ‹å¤š)'
              elif ratio < -20:
                  suggestion = 'ğŸŸ¢ åå¤šæ©Ÿæœƒï¼(æ•£æˆ¶è¢«è»‹ç©ºï¼Œä¸»åŠ›å¯èƒ½æ‹‰æŠ¬)'
              elif ratio < 0:
                  suggestion = 'ğŸŒ¤ï¸ éœ‡ç›ªåå¤š (æ•£æˆ¶ç•¥å¾®çœ‹ç©º)'
              else:
                  suggestion = 'âšª ä¸­æ€§çœ‹å¾…'

              # 3. çµ„åˆè¨Šæ¯
              msg = f'\nã€å¾®å°æŒ‡æ•£æˆ¶å¤šç©ºæ¯”æ—¥å ±ã€‘\nğŸ“… è³‡æ–™æ—¥æœŸï¼š{date_str}\nğŸ“Š æ•£æˆ¶å¤šç©ºæ¯”ï¼š{ratio_str}%\n\nğŸ’¡ åˆ†æå»ºè­°ï¼š\n{suggestion}\n\nğŸ”— è©³ç´°æ•¸æ“šï¼š{url}'

              # 4. ç™¼é€ LINE Notify
              token = os.environ['LINE_TOKEN']
              headers = {
                  'Authorization': 'Bearer ' + token,
                  'Content-Type': 'application/x-www-form-urlencoded'
              }
              payload = {'message': msg}
              requests.post('https://notify-api.line.me/api/notify', headers=headers, data=payload)
              print('è¨Šæ¯ç™¼é€æˆåŠŸ')

          except Exception as e:
              print(f'ç™¼ç”ŸéŒ¯èª¤: {e}')
          "
